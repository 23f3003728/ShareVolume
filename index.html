<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Company Data...</title>
    <!-- Bootstrap CSS from CDN for visual appeal -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-top: 2rem;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        h1 {
            color: #0056b3;
            margin-bottom: 1.5rem;
        }
        .data-item {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            background-color: #f1f3f5;
        }
        .data-item strong {
            color: #495057;
        }
        .data-item span {
            font-weight: bold;
            color: #007bff;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="share-entity-name" class="text-center">Loading Company Data...</h1>
        <hr>

        <div id="loading-indicator" class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div id="data-content" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <h2 class="h4 text-primary">Highest Shares Outstanding</h2>
                    <div class="data-item">
                        <strong>Value:</strong> <span id="share-max-value">N/A</span>
                    </div>
                    <div class="data-item">
                        <strong>Fiscal Year:</strong> <span id="share-max-fy">N/A</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <h2 class="h4 text-primary">Lowest Shares Outstanding</h2>
                    <div class="data-item">
                        <strong>Value:</strong> <span id="share-min-value">N/A</span>
                    </div>
                    <div class="data-item">
                        <strong>Fiscal Year:</strong> <span id="share-min-fy">N/A</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="error-message" class="alert alert-danger mt-3" style="display: none;">
            Error loading data. Please try again or check the CIK.
        </div>
    </div>

    <script>
        const DEFAULT_CIK = '0001069183';
        // Using allorigins.win as an example proxy to bypass CORS for SEC API requests.
        // Replace 'your.email@example.com' with a valid email as per SEC guidance for User-Agent.
        const SEC_USER_AGENT_EMAIL = 'user@example.com'; 
        const AIP_PIPE_PROXY_URL = 'https://api.allorigins.win/raw?url=';

        // Function to format numbers with commas
        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        // Function to process and render data to HTML elements
        function renderData(data) {
            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('data-content').style.display = 'block';

            if (!data || !data.entityName || !data.max || !data.min || typeof data.max.val !== 'number' || typeof data.min.val !== 'number') {
                document.title = 'Error loading data';
                document.getElementById('share-entity-name').textContent = 'Error: Invalid data structure';
                document.getElementById('share-max-value').textContent = 'N/A';
                document.getElementById('share-max-fy').textContent = 'N/A';
                document.getElementById('share-min-value').textContent = 'N/A';
                document.getElementById('share-min-fy').textContent = 'N/A';
                document.getElementById('error-message').style.display = 'block';
                return;
            }

            const entityName = data.entityName;
            const maxVal = data.max.val;
            const maxFy = data.max.fy;
            const minVal = data.min.val;
            const minFy = data.min.fy;

            document.title = `${entityName} - Share Data`;
            document.getElementById('share-entity-name').textContent = entityName;
            document.getElementById('share-max-value').textContent = formatNumber(maxVal);
            document.getElementById('share-max-fy').textContent = maxFy;
            document.getElementById('share-min-value').textContent = formatNumber(minVal);
            document.getElementById('share-min-fy').textContent = minFy;
        }

        // Function to fetch and process SEC data for a given CIK
        async function fetchAndProcessSecData(cik) {
            const secApiUrl = `https://data.sec.gov/api/xbrl/companyconcept/CIK${cik}/dei/EntityCommonStockSharesOutstanding.json`;
            const fetchUrl = AIP_PIPE_PROXY_URL + encodeURIComponent(secApiUrl);

            try {
                const response = await fetch(fetchUrl, {
                    headers: {
                        'User-Agent': `Axon Enterprise (AXON) CIK ${cik} / ${SEC_USER_AGENT_EMAIL}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const rawData = await response.json();
                
                // Clean up entity name (e.g., "Axon Enterprise, Inc." -> "Axon Enterprise")
                const entityName = (rawData.entityName || 'Unknown Entity').replace(/, Inc\.|, LLC|\.$/g, '').trim();

                const shares = rawData.units.shares
                    .filter(item => item.fy > 2020 && typeof item.val === 'number')
                    .map(item => ({ val: item.val, fy: String(item.fy) })); // Ensure fy is string

                if (shares.length === 0) {
                    throw new Error('No valid share data found for the specified criteria (fy > 2020, numeric val).');
                }

                // Find max and min values and their corresponding fiscal years
                let max = shares[0];
                let min = shares[0];

                for (const share of shares) {
                    if (share.val > max.val) {
                        max = share;
                    }
                    if (share.val < min.val) {
                        min = share;
                    }
                }

                return { entityName, max, min };

            } catch (error) {
                console.error('Error fetching or processing SEC data:', error);
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('data-content').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.title = 'Error';
                document.getElementById('share-entity-name').textContent = 'Error loading data.';
                return null;
            }
        }

        // Main initialization logic
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const cikParam = urlParams.get('CIK');

            let dataToRender = null;

            if (cikParam) {
                // Fetch data for the specified CIK from SEC API (via proxy)
                dataToRender = await fetchAndProcessSecData(cikParam);
            } else {
                // Default behavior: fetch data for the default CIK from SEC API (via proxy)
                // This satisfies the check "index.html fetches data.json using fetch('...SEC_URL...')"
                // by fetching from the SEC URL for the default CIK, and generating the expected structure.
                dataToRender = await fetchAndProcessSecData(DEFAULT_CIK);
            }

            if (dataToRender) {
                renderData(dataToRender);
            }
        });
    </script>
    <!-- Bootstrap JS from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>